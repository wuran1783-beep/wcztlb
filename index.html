<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{
  font-family:Arial;
  padding:20px;
  max-width:900px;
  margin:auto;
}
button,input,select{
  padding:10px;
  margin:6px;
  font-size:16px;
}
.word{
  font-size:28px;
  font-weight:bold;
  cursor:pointer;
}
.example{
  color:#555;
  margin-top:5px;
  cursor:pointer;
}
.card{
  border:1px solid #ddd;
  padding:15px;
  border-radius:10px;
  margin-top:15px;
}
.info{
  color:#666;
  margin-top:10px;
}
canvas{
  position:fixed;
  left:0;
  top:0;
  pointer-events:none;
}

/* ğŸŒˆ è¯æ€§é¢œè‰² */
.pos-noun{color:#3498db;}      /* åè¯ */
.pos-verb{color:#e74c3c;}      /* åŠ¨è¯ */
.pos-adjective{color:#2ecc71;} /* å½¢å®¹è¯ */
.pos-adverb{color:#9b59b6;}    /* å‰¯è¯ */
.pos-other{color:#95a5a6;}     /* å…¶ä»– */
</style>
</head>

<body>

<h1>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</h1>

<label>æ¯æ—¥å•è¯æ•°ï¼š</label>
<input type="number" id="dailyCount" value="10" min="1">

<label>é¡ºåºï¼š</label>
<select id="orderMode">
  <option value="fixed">å›ºå®šé¡ºåº</option>
  <option value="random">éšæœºé¡ºåº</option>
</select>

<label>å‘éŸ³ï¼š</label>
<select id="voiceType">
  <option value="en-US">ç¾å¼</option>
  <option value="en-GB">è‹±å¼</option>
</select>

<div>
  <button onclick="setMode('view')">ğŸ“– æµè§ˆæ¨¡å¼</button>
  <button onclick="setMode('spell')">âœ æ‹¼å†™æ¨¡å¼</button>
</div>

<button onclick="start()">å¼€å§‹ä»Šæ—¥æ‰“å¡</button>

<div id="card" class="card"></div>
<div id="progress" class="info"></div>
<div id="record" class="info"></div>

<canvas id="fireworks"></canvas>

<script>
/* ================== é…ç½® ================== */
const CACHE_KEY="WORD_CACHE_V4";
const RECORD_KEY="PUNCH_RECORD";
const TREE_INDEX_KEY="TREE_RECORD_INDEX";
const WORD_URL="https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-no-swears.txt";

let cet4=[], cet6=[];
let mode="view";
let todayList=[], index=0;

/* ================== è·å–å•è¯è¯¦æƒ…ï¼ˆå«è¯æ€§ï¼‰ ================== */
async function getWordDetail(word){
  let result={
    cn:"æš‚æ— ä¸­æ–‡ç¿»è¯‘",
    en:`This is an example for ${word}.`,
    cnEx:`è¿™æ˜¯ä¸€ä¸ªå…³äº ${word} çš„ä¾‹å¥ã€‚`,
    pos:"other"
  };

  try{
    const res=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data=await res.json();
    const meaning=data[0]?.meanings?.[0];
    if(meaning){
      result.pos=meaning.partOfSpeech || "other";
      const def=meaning.definitions?.[0];
      if(def?.example) result.en=def.example;
    }
  }catch(e){}

  try{
    const res2=await fetch(`https://api.mymemory.translated.net/get?q=${word}&langpair=en|zh`);
    const data2=await res2.json();
    result.cn=data2?.responseData?.translatedText || result.cn;
  }catch(e){}

  try{
    const res3=await fetch(
      `https://api.mymemory.translated.net/get?q=${encodeURIComponent(result.en)}&langpair=en|zh`
    );
    const data3=await res3.json();
    result.cnEx=data3?.responseData?.translatedText || result.cnEx;
  }catch(e){}

  return result;
}

/* ================== æ¨¡å¼åˆ‡æ¢ ================== */
function setMode(m){
  mode=m;
  showWord();
}

/* ================== åŠ è½½è¯åº“ ================== */
async function loadWords(){
  if(localStorage.getItem(CACHE_KEY)){
    const d=JSON.parse(localStorage.getItem(CACHE_KEY));
    cet4=d.cet4; cet6=d.cet6;
    return;
  }
  const res=await fetch(WORD_URL);
  const txt=await res.text();
  const all=txt.split("\n").filter(x=>x.trim());
  cet4=all.slice(0,3000).map(w=>({w}));
  cet6=all.slice(3000,6000).map(w=>({w}));
  localStorage.setItem(CACHE_KEY,JSON.stringify({cet4,cet6}));
}
loadWords();

/* ================== å‘éŸ³ ================== */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang=document.getElementById("voiceType").value;
  speechSynthesis.speak(u);
}

/* ================== å¼€å§‹ ================== */
function start(){
  const n=parseInt(dailyCount.value);
  const order=orderMode.value;
  let pool=[...cet4,...cet6];
  if(order==="random") pool.sort(()=>Math.random()-0.5);
  todayList=pool.slice(0,n);
  index=0;
  showWord();
}

/* ================== æŒ–ç©º ================== */
function maskWord(w){
  const a=w.split("");
  const c=Math.max(1,Math.floor(w.length/3));
  const s=new Set();
  while(s.size<c) s.add(Math.floor(Math.random()*w.length));
  s.forEach(i=>a[i]="_");
  return a.join("");
}

/* ================== æ˜¾ç¤º ================== */
async function showWord(){
  const box=document.getElementById("card");
  if(!todayList.length) return;

  if(index>=todayList.length){
    completePunch();
    return;
  }

  const w=todayList[index];
  box.innerHTML="æ­£åœ¨åŠ è½½å•è¯è¯¦æƒ…â€¦";
  const d=await getWordDetail(w.w);

  if(mode==="view"){
    box.innerHTML=`
      <div class="word pos-${d.pos}" onclick="speak('${w.w}')">${w.w}</div>
      <div>ä¸­æ–‡ï¼š${d.cn}</div>
      <div class="example" onclick="speak('${d.en}')">${d.en}<br>${d.cnEx}</div>
      <button onclick="nextWord()">ä¸‹ä¸€ä¸ª</button>
    `;
  }else{
    box.innerHTML=`
      <div class="word">${maskWord(w.w)}</div>
      <div>ä¸­æ–‡ï¼š${d.cn}</div>
      <div class="example" onclick="speak('${d.en}')">${d.en}<br>${d.cnEx}</div>
      <input id="spellInput" placeholder="è¾“å…¥å®Œæ•´å•è¯">
      <button onclick="checkSpell()">æäº¤</button>
    `;
  }

  progress.innerText=`è¿›åº¦ï¼š${index+1} / ${todayList.length}`;
}

/* ================== ä¸‹ä¸€é¢˜ ================== */
function nextWord(){ index++; showWord(); }
function checkSpell(){
  const user=spellInput.value.trim().toLowerCase();
  const cor=todayList[index].w.toLowerCase();
  alert(user===cor?"âœ… æ­£ç¡®":"âŒ æ­£ç¡®ä¸ºï¼š"+cor);
  index++; showWord();
}

/* ================== æ‰“å¡å®Œæˆ ================== */
function completePunch(){
  const now=new Date();
  const date=now.toLocaleDateString();
  const time=now.toLocaleTimeString();

  const rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  rec.push({
    date,
    time,
    words: todayList.map(x=>x.w)
  });
  localStorage.setItem(RECORD_KEY,JSON.stringify(rec));
  localStorage.setItem(TREE_INDEX_KEY, rec.length-1);

  card.innerHTML="ğŸ‰ ä»Šæ—¥æ‰“å¡å®Œæˆï¼";
  progress.innerText=`ç´¯è®¡æ‰“å¡ï¼š${rec.length} å¤©`;
  showRecord();
  firework();
}

/* ================== æ˜¾ç¤ºè®°å½• ================== */
function showRecord(){
  const rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  record.innerHTML="ğŸ“ æ‰“å¡è®°å½•ï¼š<br>"+rec.slice(-5).reverse()
    .map(r=>`${r.date} ${r.time}`).join("<br>");
}
showRecord();

/* ================== çƒŸèŠ± ================== */
function firework(){
  const c=fireworks;
  const ctx=c.getContext("2d");
  c.width=innerWidth; c.height=innerHeight;
  let p=[];
  for(let i=0;i<80;i++){
    p.push({
      x:c.width/2,y:c.height/2,
      vx:(Math.random()-0.5)*6,
      vy:(Math.random()-0.5)*6,
      life:60
    });
  }
  const t=setInterval(()=>{
    ctx.clearRect(0,0,c.width,c.height);
    p.forEach(o=>{
      ctx.fillStyle=`hsl(${Math.random()*360},100%,60%)`;
      ctx.beginPath();
      ctx.arc(o.x,o.y,3,0,Math.PI*2);
      ctx.fill();
      o.x+=o.vx; o.y+=o.vy; o.life--;
    });
    p=p.filter(o=>o.life>0);
    if(!p.length) clearInterval(t);
  },30);
}
</script>

</body>
</html>
