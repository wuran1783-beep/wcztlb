<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;padding:20px;max-width:900px;margin:auto}
button,input,select{padding:10px;margin:6px;font-size:16px}
.word{font-size:28px;font-weight:bold;color:#2c3e50;cursor:pointer}
.example{color:#555;margin-top:5px;cursor:pointer}
.card{border:1px solid #ddd;padding:15px;border-radius:10px;margin-top:15px}
.info{color:#666;margin-top:10px}
button{border-radius:8px;border:none;background:#f0f0f0;cursor:pointer}
button:hover{background:#e0e0e0}
</style>
</head>
<body>

<h1>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</h1>

<label>æ¯æ—¥å•è¯æ•°ï¼š</label>
<input type="number" id="dailyCount" value="10" min="1">

<label>é¡ºåºï¼š</label>
<select id="orderMode">
  <option value="fixed">å›ºå®šé¡ºåº</option>
  <option value="random">éšæœºé¡ºåº</option>
</select>

<label>å‘éŸ³ï¼š</label>
<select id="voiceType">
  <option value="en-US">ç¾å¼</option>
  <option value="en-GB">è‹±å¼</option>
</select>

<div>
  <button onclick="setMode('view')">ğŸ“– æµè§ˆæ¨¡å¼</button>
  <button onclick="setMode('spell')">âœ æ‹¼å†™æ¨¡å¼</button>
</div>

<button onclick="start()">å¼€å§‹ä»Šæ—¥æ‰“å¡</button>
<button onclick="resetAll()">ğŸ”„ é‡ç½®å­¦ä¹ </button>

<div id="card" class="card"></div>
<div id="progress" class="info"></div>
<div id="record" class="info"></div>

<script>
/* ===============================
   å¸¸é‡
================================ */
const WORD_URL="https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-no-swears.txt";
const CACHE_KEY="WORD_CACHE_V4";
const RECORD_KEY="PUNCH_RECORD";
const LEARNED_KEY="LEARNED_WORDS";

/* ===============================
   çŠ¶æ€
================================ */
let words=[];
let todayList=[];
let index=0;
let mode="view";

/* ===============================
   å·¥å…·
================================ */
function getLearnedWords(){
  return JSON.parse(localStorage.getItem(LEARNED_KEY)||"[]");
}
function addLearnedWord(w){
  const arr=getLearnedWords();
  if(!arr.includes(w)){
    arr.push(w);
    localStorage.setItem(LEARNED_KEY,JSON.stringify(arr));
  }
}

/* ===============================
   åŠ è½½è¯åº“
================================ */
async function loadWords(){
  if(localStorage.getItem(CACHE_KEY)){
    words=JSON.parse(localStorage.getItem(CACHE_KEY));
    return;
  }
  const res=await fetch(WORD_URL);
  const txt=await res.text();
  words=txt.split("\n").filter(Boolean);
  localStorage.setItem(CACHE_KEY,JSON.stringify(words));
}
loadWords();

/* ===============================
   æ¨¡å¼
================================ */
function setMode(m){mode=m;showWord();}

/* ===============================
   å¼€å§‹
================================ */
function start(){
  const learned=getLearnedWords();
  const available=words.filter(w=>!learned.includes(w));

  const n=parseInt(dailyCount.value);
  if(available.length===0){
    alert("ğŸ‰ æ‰€æœ‰å•è¯å·²å­¦å®Œï¼");
    return;
  }

  let pool=[...available];
  if(orderMode.value==="random") pool.sort(()=>Math.random()-0.5);

  todayList=pool.slice(0,n);
  index=0;
  showWord();
}

/* ===============================
   æ˜¾ç¤º
================================ */
function speak(t){
  const u=new SpeechSynthesisUtterance(t);
  u.lang=voiceType.value;
  speechSynthesis.speak(u);
}

async function showWord(){
  if(index>=todayList.length){
    completePunch();
    return;
  }

  const w=todayList[index];
  card.innerHTML="";

  if(mode==="view"){
    card.innerHTML=`
      <div class="word" onclick="speak('${w}')">${w}</div>
      <button onclick="nextWord()">ä¸‹ä¸€ä¸ª</button>
    `;
  }else{
    card.innerHTML=`
      <div class="word">${mask(w)}</div>
      <input id="spell">
      <button onclick="check('${w}')">æäº¤</button>
    `;
  }
  progress.innerText=`è¿›åº¦ï¼š${index+1}/${todayList.length}`;
}

function mask(w){
  return w.replace(/./g,(c,i)=>Math.random()<0.3?"_":c);
}

function nextWord(){
  addLearnedWord(todayList[index]);
  index++;
  showWord();
}

function check(w){
  const v=document.getElementById("spell").value.trim().toLowerCase();
  alert(v===w?"âœ… æ­£ç¡®":"âŒ æ­£ç¡®ï¼š"+w);
  addLearnedWord(w);
  index++;
  showWord();
}

/* ===============================
   æ‰“å¡å®Œæˆ
================================ */
function completePunch(){
  const rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  const date=new Date().toLocaleString();
  rec.push({date,words:todayList});
  localStorage.setItem(RECORD_KEY,JSON.stringify(rec));
  localStorage.setItem("TREE_RECORD_INDEX",rec.length-1);

  card.innerHTML="ğŸ‰ ä»Šæ—¥æ‰“å¡å®Œæˆï¼";
  showRecord();
}

/* ===============================
   è®°å½•
================================ */
function showRecord(){
  const rec=JSON.parse(localStorage.getItem(RECORD_KEY)||"[]");
  let html="ğŸ“’ æ‰“å¡è®°å½•ï¼š<br>";
  rec.slice(-5).reverse().forEach((r,i)=>{
    html+=`${r.date} ğŸŒ² <a href="./tree.html" onclick="localStorage.setItem('TREE_RECORD_INDEX',${rec.length-1-i})">æŸ¥çœ‹åœ£è¯æ ‘</a><br>`;
  });
  record.innerHTML=html;
}
showRecord();

/* ===============================
   é‡ç½®
================================ */
function resetAll(){
  if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å­¦ä¹ è®°å½•å—ï¼Ÿ")){
    localStorage.removeItem(RECORD_KEY);
    localStorage.removeItem(LEARNED_KEY);
    localStorage.removeItem("TREE_RECORD_INDEX");
    location.reload();
  }
}
</script>
</body>
</html>
